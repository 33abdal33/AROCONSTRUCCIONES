@model AROCONSTRUCCIONES.Dtos.OrdenCompraCreateDto
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    var proveedoresList = ViewBag.Proveedores as SelectList;
    int initialCount = Model.Detalles != null ? Model.Detalles.Count : 0;
}

@* Estilos para scrollbar premium *@
<style>
    [x-cloak] { display: none !important; }
    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>

<div x-data="{ open: true, moneda: '@Model.Moneda' }"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-[60] overflow-y-auto">

    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity"></div>

    <div class="flex items-center justify-center min-h-screen p-4">
        <div @@click.away="open = false"
             class="relative bg-white rounded-[2.5rem] shadow-2xl transform transition-all sm:my-8 sm:max-w-6xl sm:w-full border border-slate-200 overflow-hidden">

            <form asp-controller="OrdenCompra" asp-action="Create" method="post" id="formOrdenCompra" data-form-ajax="true">
                @Html.AntiForgeryToken()
                
                @* --- CAMPOS OCULTOS DE TRAZABILIDAD (VITALES) --- *@
                <input type="hidden" asp-for="ProyectoId" />    
                <input type="hidden" asp-for="RequerimientoId" /> @* <-- ESTE ES EL QUE FALTABA *@

                <div class="bg-slate-50/80 px-10 py-8 border-b border-slate-100 flex justify-between items-center">
                    <div class="flex items-center gap-5">
                        <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-xl shadow-indigo-100">
                            <i class="fas fa-file-invoice-dollar text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-slate-800 tracking-tight uppercase">Nueva Orden de Compra</h3>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Emisión de documento comercial</p>
                        </div>
                    </div>
                    <button type="button" @@click="open = false" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-200 text-slate-400 transition-all btn-cerrar-modal">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-10 space-y-8 max-h-[75vh] overflow-y-auto custom-scrollbar">

                    <div id="validationSummary" class="hidden animate-in fade-in slide-in-from-top-2 text-rose-600 bg-rose-50 p-4 rounded-2xl text-sm font-bold border border-rose-100"></div>

                    @* BANNER DE VINCULACIÓN MEJORADO *@
                    @if (Model.RequerimientoId.HasValue)
                    {
                        <div class="bg-indigo-600 rounded-3xl p-6 text-white flex items-center justify-between shadow-lg shadow-indigo-100 relative overflow-hidden">
                            <div class="relative z-10 flex items-center gap-4">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-md">
                                    <i class="fas fa-link text-white"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black uppercase tracking-widest opacity-80">Trazabilidad Activa</p>
                                    <p class="text-sm font-bold">VINCULADO AL REQUERIMIENTO ID: @Model.RequerimientoId</p>
                                </div>
                            </div>
                            <i class="fas fa-project-diagram absolute -right-4 -bottom-4 text-6xl opacity-10 -rotate-12"></i>
                        </div>
                    }

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="space-y-2">
                                    <label asp-for="IdProveedor" class="text-[11px] font-black text-slate-500 uppercase tracking-widest ml-1">Proveedor Autorizado *</label>
                                    <select asp-for="IdProveedor" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer shadow-sm" asp-items="proveedoresList" required>
                                        <option value="">Seleccione un socio comercial...</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label asp-for="Codigo" class="text-[11px] font-black text-slate-500 uppercase tracking-widest ml-1">Nro. de Referencia Interna</label>
                                    <input asp-for="Codigo" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-mono font-bold text-indigo-600 transition-all shadow-sm" placeholder="Opcional / Autogenerado" />
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label asp-for="Observaciones" class="text-[11px] font-black text-slate-500 uppercase tracking-widest ml-1">Justificación o Notas</label>
                                <textarea asp-for="Observaciones" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-medium text-slate-600 transition-all shadow-sm" rows="1" placeholder="Ej: Adquisición para cimentación..."></textarea>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 space-y-5">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Parámetros de Operación</label>
                                <div class="space-y-3 pt-2">
                                    <select asp-for="Moneda" x-model="moneda" class="w-full bg-white border-none rounded-xl py-2 text-xs font-bold text-slate-600 shadow-sm focus:ring-2 focus:ring-indigo-500/10 transition-all">
                                        <option value="PEN">Soles (S/.)</option>
                                        <option value="USD">Dólares ($)</option>
                                    </select>
                                    <select asp-for="FormaPago" class="w-full bg-white border-none rounded-xl py-2 text-xs font-bold text-slate-600 shadow-sm focus:ring-2 focus:ring-indigo-500/10 transition-all" required>
                                        <option value="Contado">Pago al Contado</option>
                                        <option value="Crédito 15 días">Crédito (15 días)</option>
                                        <option value="Crédito 30 días">Crédito (30 días)</option>
                                        <option value="Transferencia">Transferencia Bancaria</option>
                                    </select>
                                    <input asp-for="FechaEmision" type="date" class="w-full bg-white border-none rounded-xl py-2 text-xs font-bold text-slate-600 shadow-sm focus:ring-2 focus:ring-indigo-500/10 transition-all" />
                                </div>
                            </div>
                        </div>
                    </div>

                    @* ENTRADA DE MATERIALES *@
                    <div class="pt-6">
                        <div class="flex items-center gap-3 mb-5 ml-1">
                            <span class="w-8 h-px bg-slate-200"></span>
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Desglose de Materiales</h4>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 p-2 bg-slate-900 rounded-[1.5rem] shadow-xl">
                            <div class="lg:col-span-5 p-1">
                                <select id="selectMaterial" class="w-full bg-slate-800 border-none rounded-xl py-3 px-4 text-sm font-bold text-white focus:ring-2 focus:ring-indigo-500 transition-all">
                                    <option value="">Seleccione material...</option>
                                </select>
                            </div>
                            <div class="lg:col-span-2 p-1">
                                <input type="number" id="inputCantidad" class="w-full bg-slate-800 border-none rounded-xl py-3 px-4 text-sm font-bold text-white text-right" placeholder="Cant.">
                            </div>
                            <div class="lg:col-span-2 p-1">
                                <input type="number" id="inputPrecio" class="w-full bg-slate-800 border-none rounded-xl py-3 px-4 text-sm font-bold text-white text-right" placeholder="P. Unit.">
                            </div>
                            <div class="lg:col-span-3 p-1">
                                <button type="button" class="w-full h-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-indigo-900/20" id="btnAnadirMaterial">
                                    <i class="fas fa-plus-circle mr-2"></i> Añadir Partida
                                </button>
                            </div>
                        </div>
                    </div>

                    @* TABLA DE DETALLES *@
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-xl shadow-slate-200/30 overflow-hidden mt-6">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead class="bg-slate-50/80">
                                <tr>
                                    <th class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">Descripción del Insumo</th>
                                    <th class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider w-32">Cantidad</th>
                                    <th class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider w-36">Precio Unit.</th>
                                    <th class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider w-40">Subtotal</th>
                                    <th class="px-6 py-4 w-16"></th>
                                </tr>
                            </thead>
                            <tbody id="tablaDetallesBody" class="divide-y divide-slate-50 bg-white">
                                @if (Model.Detalles != null && Model.Detalles.Any())
                                {
                                    for (int i = 0; i < Model.Detalles.Count; i++)
                                    {
                                        var det = Model.Detalles[i];
                                        var subtotal = det.Cantidad * det.PrecioUnitario;
                                        <tr class="group animate-in fade-in slide-in-from-left-2 duration-300" data-material-id="@det.IdMaterial">
                                            <td class="px-6 py-5">
                                                <span class="text-sm font-bold text-slate-700">@det.MaterialNombre</span>
                                                <input type="hidden" name="Detalles.Index" value="@i" />
                                                <input type="hidden" name="Detalles[@i].IdMaterial" value="@det.IdMaterial" />
                                                <input type="hidden" name="Detalles[@i].IdDetalleRequerimiento" value="@det.IdDetalleRequerimiento" />
                                            </td>
                                            <td class="px-6 py-5">
                                                <input type="number" step="any" name="Detalles[@i].Cantidad" value="@det.Cantidad.ToString("0.00")"
                                                       class="w-full text-right border-slate-200 rounded-xl text-sm font-bold text-slate-600 focus:ring-indigo-500/20 row-cantidad" oninput="actualizarFila(this)" />
                                            </td>
                                            <td class="px-6 py-5">
                                                <input type="number" step="any" name="Detalles[@i].PrecioUnitario" value="@det.PrecioUnitario.ToString("0.00")"
                                                       class="w-full text-right border-slate-200 rounded-xl text-sm font-bold text-slate-600 focus:ring-indigo-500/20 row-precio" oninput="actualizarFila(this)" />
                                            </td>
                                            <td class="px-6 py-5 text-right font-black text-slate-900 subtotal-celda" data-subtotal="@subtotal">
                                                S/ @subtotal.ToString("N2")
                                            </td>
                                            <td class="px-6 py-5 text-center">
                                                <button type="button" class="w-8 h-8 rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all btn-remover-fila"><i class="fas fa-trash-alt text-xs"></i></button>
                                            </td>
                                        </tr>
                                    }
                                }
                                <tr id="fila-vacia" class="@(initialCount > 0 ? "hidden" : "")">
                                    <td colspan="5" class="px-6 py-12 text-center">
                                        <div class="flex flex-col items-center opacity-30">
                                            <i class="fas fa-box-open text-4xl mb-3"></i>
                                            <p class="text-sm font-bold uppercase tracking-widest text-slate-400">Sin materiales añadidos</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-slate-900 px-10 py-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-6 rounded-b-[2.5rem]">
                    <div class="flex flex-col md:flex-row items-center gap-10">
                        <div>
                            <p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.2em] mb-1">Inversión Estimada</p>
                            <h3 class="text-4xl font-black text-white tracking-tighter" id="totalGeneral">S/ 0.00</h3>
                        </div>
                        <div class="hidden md:block w-px h-12 bg-white/10"></div>
                        <div class="text-center md:text-left">
                            <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Estado de Emisión</p>
                            <span class="px-3 py-1 rounded-full bg-amber-500/10 text-amber-500 text-[10px] font-black uppercase">Borrador / Pendiente</span>
                        </div>
                    </div>

                    <div class="flex gap-4 w-full md:w-auto">
                        <button type="button" @@click="open = false" class="flex-1 md:flex-none px-8 py-3 text-xs font-black text-slate-400 hover:text-white transition-all uppercase tracking-widest btn-cerrar-modal">
                            Descartar
                        </button>
                        <button type="submit" class="flex-1 md:flex-none px-10 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-xs shadow-2xl shadow-indigo-900/40 transition-all uppercase tracking-widest">
                            <i class="fas fa-save mr-2"></i> Procesar Orden
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function actualizarFila(input) {
        const $tr = $(input).closest('tr');
        const cantidad = parseFloat($tr.find('.row-cantidad').val()) || 0;
        const precio = parseFloat($tr.find('.row-precio').val()) || 0;
        const subtotal = cantidad * precio;

        const monedaSimbolo = $('#Moneda').val() === 'PEN' ? 'S/' : '$';
        $tr.find('.subtotal-celda').attr('data-subtotal', subtotal).text(`${monedaSimbolo} ${subtotal.toLocaleString('es-PE', { minimumFractionDigits: 2 })}`);
        actualizarTotalGeneral();
    }

    function actualizarTotalGeneral() {
        let total = 0;
        $('.subtotal-celda').each(function() {
            total += parseFloat($(this).attr('data-subtotal')) || 0;
        });
        const moneda = $('#Moneda').val() === 'PEN' ? 'S/' : '$';
        $('#totalGeneral').text(`${moneda} ${total.toLocaleString('es-PE', { minimumFractionDigits: 2 })}`);
    }

    $(document).ready(function () {
        let detalleIndex = @initialCount;
        const $tablaBody = $('#tablaDetallesBody');
        const $form = $('#formOrdenCompra');

        function toggleFilaVacia() {
            $('#fila-vacia').toggleClass('hidden', $tablaBody.find('tr').not('#fila-vacia').length > 0);
        }

        actualizarTotalGeneral();

        // Carga de catálogo basada en proveedor
        $('#IdProveedor').on('change', function() {
            const proveedorId = $(this).val();
            const $selectMat = $('#selectMaterial');
            if (!proveedorId) {
                $selectMat.empty().append('<option>[Seleccione Proveedor]</option>').prop('disabled', true);
                return;
            }
            $.get('@Url.Action("GetMaterialesPorProveedor", "OrdenCompra")', { proveedorId: proveedorId }, function(data) {
                $selectMat.empty().append('<option value="">Seleccione material...</option>');
                $.each(data, function(i, item) {
                    $selectMat.append(`<option value="${item.value}" data-texto="${item.text}">${item.text}</option>`);
                });
                $selectMat.prop('disabled', false);
            });
        });

        // Evento Añadir Item Manual
        $('#btnAnadirMaterial').on('click', function () {
            const matId = $('#selectMaterial').val();
            const matTexto = $('#selectMaterial option:selected').data('texto');
            const cantNueva = parseFloat($('#inputCantidad').val()) || 0;
            const prec = parseFloat($('#inputPrecio').val()) || 0;

            if (!matId || cantNueva <= 0 || prec <= 0) {
                Swal.fire({ icon: 'warning', title: 'Atención', text: 'Verifique material, cantidad y precio.', background: '#f8fafc' });
                return;
            }

            let filaExistente = $tablaBody.find(`tr[data-material-id="${matId}"]`);

            if (filaExistente.length > 0) {
                const $inputCant = filaExistente.find('.row-cantidad');
                const total = (parseFloat($inputCant.val()) || 0) + cantNueva;
                $inputCant.val(total.toFixed(2));
                actualizarFila($inputCant);
                filaExistente.addClass('bg-indigo-50');
                setTimeout(() => filaExistente.removeClass('bg-indigo-50'), 1000);
            } else {
                const monedaSimbolo = $('#Moneda').val() === 'PEN' ? 'S/' : '$';
                const sub = cantNueva * prec;
                const fila = `
                    <tr class="text-sm transition-all group animate-in fade-in slide-in-from-left-2 duration-300" data-material-id="${matId}">
                        <td class="px-6 py-5">
                            <span class="font-bold text-slate-700 uppercase tracking-tight">${matTexto}</span>
                            <input type="hidden" name="Detalles.Index" value="${detalleIndex}" />
                            <input type="hidden" name="Detalles[${detalleIndex}].IdMaterial" value="${matId}" />
                        </td>
                        <td class="px-6 py-5">
                            <input type="number" step="any" name="Detalles[${detalleIndex}].Cantidad" value="${cantNueva.toFixed(2)}"
                                   class="w-full text-right border-slate-200 rounded-xl text-sm font-bold text-slate-600 row-cantidad" oninput="actualizarFila(this)" />
                        </td>
                        <td class="px-6 py-5">
                            <input type="number" step="any" name="Detalles[${detalleIndex}].PrecioUnitario" value="${prec.toFixed(2)}"
                                   class="w-full text-right border-slate-200 rounded-xl text-sm font-bold text-slate-600 row-precio" oninput="actualizarFila(this)" />
                        </td>
                        <td class="px-6 py-5 text-right font-black text-slate-900 subtotal-celda" data-subtotal="${sub}">
                            ${monedaSimbolo} ${sub.toLocaleString('es-PE', { minimumFractionDigits: 2 })}
                        </td>
                        <td class="px-6 py-5 text-center">
                            <button type="button" class="w-8 h-8 rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all btn-remover-fila"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`; 
                $tablaBody.append(fila);
                detalleIndex++;
            }
            actualizarTotalGeneral();
            toggleFilaVacia();
            $('#inputCantidad, #inputPrecio').val('');
        });

        $tablaBody.on('click', '.btn-remover-fila', function () {
            $(this).closest('tr').remove();
            actualizarTotalGeneral();
            toggleFilaVacia();
        });
    });
</script>