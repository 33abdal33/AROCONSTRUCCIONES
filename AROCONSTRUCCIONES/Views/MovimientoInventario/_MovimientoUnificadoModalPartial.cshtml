@using AROCONSTRUCCIONES.Dtos
@model MovimientoInventarioDto
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    // Cargamos los dropdowns del ViewBag
    var almacenes = ViewBag.Almacenes as SelectList;
    var materiales = ViewBag.Materiales as IEnumerable<SelectListItem>;
    var proveedores = ViewBag.Proveedores as SelectList;
    var proyectos = ViewBag.Proyectos as SelectList; // <-- 1. AÑADIDO
}

<div x-data="{ open: true, tipo: 'INGRESO', motivo: '@(Model.Motivo ?? "")' }"
     x-show="open"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 overflow-y-auto"
     style="display: none;">

    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="flex items-center justify-center min-h-screen p-4">

        <div x-on:click.away="open = false"
             class="relative bg-white rounded-lg shadow-xl transform transition-all sm:my-8 sm:max-w-2xl sm:w-full">

            <form id="formMovimiento"
                  asp-controller="MovimientoInventario"
                  x-bind:action="tipo === 'INGRESO' ? '@Url.Action("RegistrarIngreso", "MovimientoInventario")' : '@Url.Action("RegistrarSalida", "MovimientoInventario")'"
                  method="post"
                  data-form-ajax="true">

                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="TipoMovimiento" x-model="tipo" />

                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 border-b border-gray-200 rounded-t-lg">
                    <h3 class="text-xl leading-6 font-semibold text-gray-900">
                        Registrar Movimiento
                    </h3>
                </div>

                <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">

                    <fieldset>
                        <legend class="text-sm font-medium text-gray-700">Tipo de Movimiento *</legend>
                        <div class="mt-2 grid grid-cols-2 gap-4">
                            <label x-on:click="tipo = 'INGRESO'"
                                   :class="{ 'ring-2 ring-blue-500 bg-blue-50 border-blue-500': tipo === 'INGRESO', 'border-gray-300': tipo !== 'INGRESO' }"
                                   class="relative flex items-center p-4 rounded-lg border cursor-pointer transition-all">
                                <i class="fas fa-arrow-down text-green-500 text-xl"></i>
                                <span class="ml-3">
                                    <strong class="font-medium text-gray-900">Ingreso</strong>
                                    <span class="block text-sm text-gray-500">Ingreso de materiales</span>
                                </span>
                                <input type="radio" name="radioTipoMovimiento" value="INGRESO" class="sr-only" checked>
                            </label>
                            <label x-on:click="tipo = 'SALIDA'"
                                   :class="{ 'ring-2 ring-red-500 bg-red-50 border-red-500': tipo === 'SALIDA', 'border-gray-300': tipo !== 'SALIDA' }"
                                   class="relative flex items-center p-4 rounded-lg border cursor-pointer transition-all">
                                <i class="fas fa-arrow-up text-red-500 text-xl"></i>
                                <span class="ml-3">
                                    <strong class="font-medium text-gray-900">Salida</strong>
                                    <span class="block text-sm text-gray-500">Salida de materiales</span>
                                </span>
                                <input type="radio" name="radioTipoMovimiento" value="SALIDA" class="sr-only">
                            </label>
                        </div>
                    </fieldset>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label asp-for="MaterialId" class="block text-sm font-medium text-gray-700">Material *</label>
                            <select asp-for="MaterialId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required asp-items="materiales">
                                <option value="">Seleccione...</option>
                            </select>
                            <span asp-validation-for="MaterialId" class="text-sm text-red-600"></span>
                        </div>
                        <div>
                            <label asp-for="AlmacenId" class="block text-sm font-medium text-gray-700">Almacén *</label>
                            <select asp-for="AlmacenId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required asp-items="almacenes">
                                <option value="">Seleccione...</option>
                            </select>
                            <span asp-validation-for="AlmacenId" class="text-sm text-red-600"></span>
                        </div>
                        <div>
                            <label asp-for="Cantidad" class="block text-sm font-medium text-gray-700">Cantidad *</label>
                            <input asp-for="Cantidad" type="number" min="1" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            <span asp-validation-for="Cantidad" class="text-sm text-red-600"></span>
                        </div>
                        <div>
                            <label asp-for="NroFacturaGuia" class="block text-sm font-medium text-gray-700">Documento de Referencia</label>
                            <input asp-for="NroFacturaGuia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Factura, Guía o ID Proyecto" />
                            <span asp-validation-for="NroFacturaGuia" class="text-sm text-red-600"></span>
                        </div>
                    </div>

                    <div x-show="tipo === 'INGRESO'" x-transition class="space-y-4">
                        <hr />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label asp-for="CostoUnitarioCompra" class="block text-sm font-medium text-gray-700">Costo Unitario (S/.) *</label>
                                <input asp-for="CostoUnitarioCompra" type="number" step="0.01" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" x-bind:required="tipo === 'INGRESO'" />
                                <span asp-validation-for="CostoUnitarioCompra" class="text-sm text-red-600"></span>
                            </div>
                            <div>
                                <label asp-for="ProveedorId" class="block text-sm font-medium text-gray-700">Proveedor</label>
                                <select asp-for="ProveedorId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" asp-items="proveedores">
                                    <option value="">Seleccione...</option>
                                </select>
                                <span asp-validation-for="ProveedorId" class="text-sm text-red-600"></span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label asp-for="Motivo" class="block text-sm font-medium text-gray-700">Motivo *</label>
                            <select asp-for="Motivo" x-model="motivo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                <option value="">Selecciona un motivo</option>
                                <optgroup label="Ingresos">
                                    <option value="COMPRA">Compra (Ingreso)</option>
                                    <option value="DEVOLUCION_PROYECTO">Devolución de Proyecto (Ingreso)</option>
                                    <option value="AJUSTE_POSITIVO">Ajuste Positivo (Ingreso)</option>
                                </optgroup>
                                <optgroup label="Salidas">
                                    <option value="CONSUMO_PROYECTO">Consumo Proyecto (Salida)</option>
                                    <option value="VENTA">Venta (Salida)</option>
                                    <option value="AJUSTE_NEGATIVO">Ajuste Negativo (Salida)</option>
                                </optgroup>
                            </select>
                            <span asp-validation-for="Motivo" class="text-sm text-red-600"></span>
                        </div>
                        <div>
                            <label asp-for="ResponsableNombre" class="block text-sm font-medium text-gray-700">Responsable *</label>
                            <input asp-for="ResponsableNombre" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Nombre del responsable" required />
                            <span asp-validation-for="ResponsableNombre" class="text-sm text-red-600"></span>
                        </div>
                    </div>

                    <div x-show="motivo === 'CONSUMO_PROYECTO'" x-transition class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <div>
                            <label asp-for="ProyectoId" class="block text-sm font-medium text-gray-700">Asignar a Proyecto *</label>
                            <select asp-for="ProyectoId"
                                    id="selectProyectoMovimiento"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    asp-items="proyectos"
                                    x-bind:required="motivo === 'CONSUMO_PROYECTO'">
                                <option value="">Seleccione el proyecto...</option>
                            </select>
                            <span asp-validation-for="ProyectoId" class="text-sm text-red-600"></span>
                        </div>

                        <div>
                            <label asp-for="PartidaId" class="block text-sm font-medium text-gray-700">Partida Presupuestaria</label>
                            <select asp-for="PartidaId"
                                    id="selectPartidaMovimiento"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="">(Opcional) Seleccione partida...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">El costo se sumará a esta partida.</p>
                        </div>
                    </div>
                    <div>
                        <label asp-for="FechaMovimiento" class="block text-sm font-medium text-gray-700">Fecha del Movimiento</label>
                        <input asp-for="FechaMovimiento" type="datetime-local" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required />
                        <span asp-validation-for="FechaMovimiento" class="text-sm text-red-600"></span>
                    </div>
                    <div>
                        <label asp-for="Notas" class="block text-sm font-medium text-gray-700">Notas Adicionales</label>
                        <textarea asp-for="Notas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="2" placeholder="Observaciones..."></textarea>
                        <span asp-validation-for="Notas" class="text-sm text-red-600"></span>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse rounded-b-lg">
                    <button type="submit"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition-colors"
                            :class="{ 'bg-blue-600 hover:bg-blue-700': tipo === 'INGRESO', 'bg-red-600 hover:bg-red-700': tipo === 'SALIDA' }">
                        <span x-show="tipo === 'INGRESO'"><i class="fas fa-save mr-2"></i> Registrar Ingreso</span>
                        <span x-show="tipo === 'SALIDA'"><i class="fas fa-save mr-2"></i> Registrar Salida</span>
                    </button>
                    <button type="button" x-on:click="open = false"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        // Lógica de Dropdown en Cascada (Proyecto -> Partidas)
        $('#selectProyectoMovimiento').on('change', function() {
            const proyectoId = $(this).val();
            const $comboPartidas = $('#selectPartidaMovimiento');

            $comboPartidas.empty().append('<option value="">Cargando partidas...</option>');

            if (proyectoId) {
                $.get('@Url.Action("GetPartidasPorProyecto", "MovimientoInventario")', { proyectoId: proyectoId }, function(data) {
                    $comboPartidas.empty();
                    $comboPartidas.append('<option value="">-- Seleccione Partida (Opcional) --</option>');

                    if (data.length > 0) {
                        $.each(data, function(i, item) {
                            $comboPartidas.append($('<option>', {
                                value: item.value,
                                text: item.text
                            }));
                        });
                    } else {
                        $comboPartidas.append('<option value="">Este proyecto no tiene presupuesto cargado</option>');
                    }
                });
            } else {
                $comboPartidas.empty().append('<option value="">Seleccione un proyecto primero</option>');
            }
        });
    });
</script>