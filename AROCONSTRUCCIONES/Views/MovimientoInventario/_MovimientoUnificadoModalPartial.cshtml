@using AROCONSTRUCCIONES.Dtos
@model MovimientoInventarioDto
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    var almacenes = ViewBag.Almacenes as SelectList;
    var materiales = ViewBag.Materiales as IEnumerable<SelectListItem>;
    var proveedores = ViewBag.Proveedores as SelectList;
    var proyectos = ViewBag.Proyectos as SelectList;
}

<div x-data="{ open: true, tipo: 'INGRESO', motivo: '@(Model.Motivo ?? "")' }"
     x-show="open"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 scale-95"
     x-transition:enter-end="opacity-100 scale-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100 scale-100"
     x-transition:leave-end="opacity-0 scale-95"
     class="fixed inset-0 z-[60] overflow-y-auto"
     style="display: none;">

    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>

    <div class="flex items-center justify-center min-h-screen p-4 text-center">
        <div x-on:click.away="open = false"
             class="relative bg-white rounded-[2rem] shadow-2xl transform transition-all sm:my-8 sm:max-w-3xl sm:w-full overflow-hidden border border-slate-200">

            <form id="formMovimiento"
                  asp-controller="MovimientoInventario"
                  x-bind:action="tipo === 'INGRESO' ? '@Url.Action("RegistrarIngreso", "MovimientoInventario")' : '@Url.Action("RegistrarSalida", "MovimientoInventario")'"
                  method="post"
                  data-form-ajax="true">

                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="TipoMovimiento" x-model="tipo" />

                <div :class="tipo === 'INGRESO' ? 'bg-emerald-50/50 border-emerald-100' : 'bg-rose-50/50 border-rose-100'"
                     class="px-8 pt-8 pb-6 border-b text-left transition-colors duration-500">
                    <div class="flex items-center gap-4 mb-2">
                        <div :class="tipo === 'INGRESO' ? 'bg-emerald-500 shadow-emerald-100' : 'bg-rose-500 shadow-rose-100'"
                             class="w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg transition-colors duration-500">
                            <i :class="tipo === 'INGRESO' ? 'fa-arrow-down' : 'fa-arrow-up'" class="fas text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-slate-800 tracking-tight">Registro de Movimiento Operativo</h3>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Módulo de Logística e Inventario</p>
                        </div>
                    </div>
                </div>

                <div class="p-8 space-y-8 text-left max-h-[65vh] overflow-y-auto custom-scrollbar">

                    <fieldset class="space-y-3">
                        <legend class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Seleccione Naturaleza del Movimiento *</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <label x-on:click="tipo = 'INGRESO'"
                                   :class="tipo === 'INGRESO' ? 'ring-2 ring-emerald-500 bg-emerald-50 border-emerald-200' : 'border-slate-200 hover:bg-slate-50'"
                                   class="relative flex items-center p-4 rounded-2xl border cursor-pointer transition-all group">
                                <div :class="tipo === 'INGRESO' ? 'bg-emerald-500' : 'bg-slate-200 group-hover:bg-slate-300'" class="w-10 h-10 rounded-xl flex items-center justify-center transition-colors">
                                    <i class="fas fa-plus text-white text-xs"></i>
                                </div>
                                <div class="ml-4">
                                    <strong class="block text-sm font-bold text-slate-800">Entrada / Ingreso</strong>
                                    <span class="block text-[10px] font-medium text-slate-500 uppercase">Aumento de stock</span>
                                </div>
                                <input type="radio" name="radioTipoMovimiento" value="INGRESO" class="sr-only" :checked="tipo === 'INGRESO'">
                            </label>

                            <label x-on:click="tipo = 'SALIDA'"
                                   :class="tipo === 'SALIDA' ? 'ring-2 ring-rose-500 bg-rose-50 border-rose-200' : 'border-slate-200 hover:bg-slate-50'"
                                   class="relative flex items-center p-4 rounded-2xl border cursor-pointer transition-all group">
                                <div :class="tipo === 'SALIDA' ? 'bg-rose-500' : 'bg-slate-200 group-hover:bg-slate-300'" class="w-10 h-10 rounded-xl flex items-center justify-center transition-colors">
                                    <i class="fas fa-minus text-white text-xs"></i>
                                </div>
                                <div class="ml-4">
                                    <strong class="block text-sm font-bold text-slate-800">Salida / Egreso</strong>
                                    <span class="block text-[10px] font-medium text-slate-500 uppercase">Disminución de stock</span>
                                </div>
                                <input type="radio" name="radioTipoMovimiento" value="SALIDA" class="sr-only" :checked="tipo === 'SALIDA'">
                            </label>
                        </div>
                    </fieldset>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 p-6 bg-slate-50 rounded-3xl border border-slate-100">
                        <div class="space-y-2">
                            <label asp-for="MaterialId" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Insumo / Material *</label>
                            <select asp-for="MaterialId" class="w-full px-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer" required asp-items="materiales">
                                <option value="">Buscar material...</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label asp-for="AlmacenId" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Sede de Almacén *</label>
                            <select asp-for="AlmacenId" class="w-full px-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer" required asp-items="almacenes">
                                <option value="">Seleccione sede...</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label asp-for="Cantidad" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Cantidad a Procesar *</label>
                            <input asp-for="Cantidad" type="number" step="0.01" class="w-full px-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-black text-slate-800 transition-all" placeholder="0.00" required />
                        </div>
                        <div class="space-y-2">
                            <label asp-for="NroFacturaGuia" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Documento de Respaldo</label>
                            <input asp-for="NroFacturaGuia" class="w-full px-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all placeholder:text-slate-300" placeholder="Ej: F001-000123" />
                        </div>
                    </div>

                    <div x-show="tipo === 'INGRESO'" x-transition class="space-y-5">
                        <div class="h-px bg-slate-100 w-full"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-2">
                                <label asp-for="CostoUnitarioCompra" class="text-[11px] font-black text-emerald-600 uppercase tracking-widest ml-1">Costo Unitario (S/.) *</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-4 font-bold text-emerald-500 text-xs">S/</span>
                                    <input asp-for="CostoUnitarioCompra" type="number" step="0.01" class="w-full pl-11 pr-4 py-3 rounded-xl border-none bg-emerald-50/30 focus:bg-white focus:ring-4 focus:ring-emerald-500/10 outline-none text-sm font-black text-slate-800 transition-all" x-bind:required="tipo === 'INGRESO'" />
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label asp-for="ProveedorId" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Proveedor Relacionado</label>
                                <select asp-for="ProveedorId" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer" asp-items="proveedores">
                                    <option value="">Seleccione proveedor...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-2">
                                <label asp-for="Motivo" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Motivo / Justificación *</label>
                                <select asp-for="Motivo" x-model="motivo" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer" required>
                                    <option value="">Seleccione razón...</option>
                                    <optgroup label="🟢 INGRESOS">
                                        <option value="COMPRA">Compra (Stock)</option>
                                        <option value="DEVOLUCION_PROYECTO">Devolución de Obra</option>
                                        <option value="AJUSTE_POSITIVO">Ajuste de Inventario (+)</option>
                                    </optgroup>
                                    <optgroup label="🔴 SALIDAS">
                                        <option value="CONSUMO_PROYECTO">Consumo en Proyecto</option>
                                        <option value="VENTA">Venta de Material</option>
                                        <option value="AJUSTE_NEGATIVO">Ajuste de Inventario (-)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label asp-for="ResponsableNombre" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Personal Responsable *</label>
                                <input asp-for="ResponsableNombre" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all" placeholder="Nombre completo" required />
                            </div>
                        </div>

                        <div x-show="motivo === 'CONSUMO_PROYECTO'"
                             x-transition
                             class="p-6 bg-amber-50 rounded-3xl border border-amber-100 grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-2">
                                <label asp-for="ProyectoId" class="text-[11px] font-black text-amber-600 uppercase tracking-widest ml-1">Destino: Proyecto / Obra *</label>
                                <select asp-for="ProyectoId" id="selectProyectoMovimiento" class="w-full px-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-4 focus:ring-amber-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer" asp-items="proyectos" x-bind:required="motivo === 'CONSUMO_PROYECTO'">
                                    <option value="">Seleccione obra...</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label asp-for="PartidaId" class="text-[11px] font-black text-amber-600 uppercase tracking-widest ml-1">Partida Presupuestaria</label>
                                <select asp-for="PartidaId" id="selectPartidaMovimiento" class="w-full px-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-4 focus:ring-amber-500/10 outline-none text-sm font-bold text-slate-700 transition-all cursor-pointer">
                                    <option value="">(Opcional) Seleccione partida...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-2">
                            <label asp-for="FechaMovimiento" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Fecha de Registro</label>
                            <input asp-for="FechaMovimiento" type="datetime-local" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required />
                        </div>
                        <div class="space-y-2">
                            <label asp-for="Notas" class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Observaciones Finales</label>
                            <textarea asp-for="Notas" class="w-full px-4 py-3 rounded-xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-700 transition-all" rows="1" placeholder="Detalles internos..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="px-8 py-6 bg-slate-50/50 border-t border-slate-100 flex flex-col sm:flex-row-reverse gap-3">
                    <button type="submit"
                            class="w-full sm:w-auto px-10 py-3 text-xs font-black rounded-xl shadow-lg transition-all uppercase tracking-widest"
                            :class="tipo === 'INGRESO' ? 'bg-emerald-600 hover:bg-emerald-700 text-white shadow-emerald-100' : 'bg-rose-600 hover:bg-rose-700 text-white shadow-rose-100'">
                        <i class="fas fa-save mr-2"></i>
                        <span x-text="tipo === 'INGRESO' ? 'Confirmar Ingreso' : 'Confirmar Salida'"></span>
                    </button>
                    <button type="button" x-on:click="open = false"
                            class="w-full sm:w-auto px-10 py-3 bg-white border border-slate-200 text-slate-500 hover:bg-slate-100 text-xs font-black rounded-xl transition-all uppercase tracking-widest">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>