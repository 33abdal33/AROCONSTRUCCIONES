@model IEnumerable<AROCONSTRUCCIONES.Dtos.MovimientoInventarioDto>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    var almacenesSelectList = ViewBag.Almacenes as SelectList;
}

<div class="pt-4">

    @* 1. Encabezado y Botón "Registrar Movimiento" (CORREGIDO) *@
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-slate-700">
            <i class="fas fa-dolly mr-2 text-blue-600"></i> Historial de Movimientos
        </h3>

        <button type="button"
                class="flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                data-modal-url="@Url.Action("CargarFormularioMovimiento", "Inventario")">
            <i class="fas fa-plus mr-2"></i> Registrar Movimiento
        </button>
    </div>

    @* 2. Filtros de la Tabla (CORREGIDOS CON TAILWIND) *@
    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
        <div class="relative w-full md:w-1/3">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                <i class="fas fa-search text-slate-400"></i>
            </span>
            <input type="text" class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 bg-white focus:border-blue-500 focus:ring-0" id="inputBuscarMovimiento" placeholder="Buscar por material o documento...">
        </div>
        <div class="flex w-full md:w-auto gap-2">
            <select class="px-3 py-2 rounded-lg border border-slate-300 bg-white focus:border-blue-500 focus:ring-0 text-sm" id="filtroTipoMovimiento" style="min-width: 150px;">
                <option selected value="">Todos Tipos</option>
                <option value="INGRESO">ENTRADA</option>
                <option value="SALIDA">SALIDA</option>
            </select>
            <select class="px-3 py-2 rounded-lg border border-slate-300 bg-white focus:border-blue-500 focus:ring-0 text-sm" id="filtroAlmacen" style="min-width: 200px;">
                <option selected value="">Todos los Almacenes</option>
                @if (almacenesSelectList != null)
                {
                    @foreach (var item in almacenesSelectList)
                    {
                        <option value="@item.Text">@item.Text</option>
                    }
                }
            </select>
        </div>
    </div>

    <partial name="_MensajesTempDataPartial" />

    @* 3. Tabla de Movimientos (LIMPIA DE ERRORES) *@
    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200" id="dataTableMovimientos">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha y Hora</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tipo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Material</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Cantidad</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Almacén</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Documento</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Motivo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Responsable</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Stock Final</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                @if (Model != null && Model.Any())
                {
                    @foreach (var movimiento in Model)
                    {
                        var esEntrada = movimiento.TipoMovimiento == "INGRESO";
                        var tipoClaseText = esEntrada ? "text-green-600" : "text-red-600";
                        var tipoClaseBg = esEntrada ? "bg-green-100" : "bg-red-100";
                        var iconoTipo = esEntrada ? "fas fa-arrow-up" : "fas fa-arrow-down";
                        var signoCantidad = esEntrada ? "+" : "-";

                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">@movimiento.FechaMovimiento.ToString("yyyy-MM-dd HH:mm")</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full @tipoClaseBg @tipoClaseText">
                                    <i class="@iconoTipo mr-1"></i>
                                    @(esEntrada ? "ENTRADA" : "SALIDA")
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-slate-900">@movimiento.MaterialNombre</div>
                                <div class="text-sm text-slate-500">@movimiento.MaterialCodigo</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                                <span class="font-bold @tipoClaseText">
                                    @signoCantidad@movimiento.Cantidad.ToString("N0")
                                </span>
                                <span class="text-slate-500 ml-1">@movimiento.UnidadMedida</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">@movimiento.AlmacenNombre</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">@movimiento.NroFacturaGuia</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">@movimiento.Motivo</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">@movimiento.ResponsableNombre</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-bold text-right">
                                @movimiento.StockFinal.ToString("N0")
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-slate-500">
                            No hay movimientos de inventario registrados.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>