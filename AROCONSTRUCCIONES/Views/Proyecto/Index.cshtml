@model IEnumerable<AROCONSTRUCCIONES.Dtos.ProyectoDto>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Gestión de Proyectos";
    var dashboardData = ViewBag.DashboardData as AROCONSTRUCCIONES.Dtos.ProyectoDashboardDto
                        ?? new AROCONSTRUCCIONES.Dtos.ProyectoDashboardDto();

    // Obtenemos el primer ID de proyecto para la carga inicial de requerimientos
    var primerProyectoId = Model.FirstOrDefault()?.Id ?? 0;
}

<!-- 1. Encabezado de estadísticas (KPIs) -->
<partial name="_ProyectosHeaderPartial" model="dashboardData" />

<!-- 2. Contenedor del Módulo con Pestañas -->
<div x-data="{ activeTab: 'proyectos' }" class="w-full mt-6">

    <!-- Gráfico (Placeholder) -->
    <div class="bg-white rounded-lg shadow-md mb-6">
        <div class="p-4 md:p-6">
            <h5 class="text-xl font-semibold text-slate-700">Avance de Proyectos</h5>
            <p class="text-sm text-slate-500">Comparativo planificado vs ejecutado (%)</p>
            <div class="mt-4 h-64 flex items-center justify-center bg-slate-50 text-center text-slate-400 rounded-lg">
                <i class="fas fa-chart-bar fa-2x mr-3"></i> (Gráfico de Barras - Próximamente)
            </div>
        </div>
    </div>

    <!-- 3. Navegación de Pestañas (Estilo Tailwind) -->
    <div class="flex space-x-2">
        <nav class="inline-flex h-10 items-center justify-center rounded-lg bg-gray-200 p-1 text-gray-600" aria-label="Tabs">
            @{
                const string activeStyle = "bg-white text-gray-900 shadow-sm";
                const string inactiveStyle = "text-gray-600 hover:bg-white/50";
                const string baseClasses = "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium transition-all";
            }

            <!-- Pestaña Proyectos -->
            <button x-on:click="activeTab = 'proyectos'; loadTabContent('@Url.Action("ListaProyectosPartial", "Proyecto")', '#proyectos-content')"
                    :class="{ '@activeStyle': activeTab === 'proyectos', '@inactiveStyle': activeTab !== 'proyectos' }"
                    class="@baseClasses"
                    data-tab-url="@Url.Action("ListaProyectosPartial", "Proyecto")">
                <i class="fas fa-tasks mr-2"></i> Proyectos
            </button>

            <!-- Pestaña Requerimientos -->
            <button x-on:click="activeTab = 'requerimientos'; loadTabContent('@Url.Action("ListaRequerimientosPartial", "Requerimiento")', '#requerimientos-content')"
                    :class="{ '@activeStyle': activeTab === 'requerimientos', '@inactiveStyle': activeTab !== 'requerimientos' }"
                    class="@baseClasses"
                    data-tab-url="@Url.Action("ListaRequerimientosPartial", "Requerimiento")">
                <i class="fas fa-clipboard-list mr-2"></i> Requerimientos
            </button>
        </nav>  
    </div>

    <!-- 4. Contenedor del Contenido de la Pestaña -->
    <div id="tab-content-container" class="mt-6">

        <!-- Contenido de Pestaña 1 (Proyectos) -->
        <div id="proyectos-content" x-show="activeTab === 'proyectos'" class="hidden">
            <div class="flex justify-center items-center p-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        </div>

        <!-- Contenido de Pestaña 2 (Requerimientos) -->
        <div id="requerimientos-content" x-show="activeTab === 'requerimientos'" class="hidden">
            <div class="flex justify-center items-center p-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        </div>
    </div>

    <!-- 5. Placeholder para los Modales -->
    <div id="modal-placeholder"></div>

</div>

@section Scripts {
    <!-- Carga los scripts de validación ANTES que site.js -->
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script src="~/js/logistica-tabs.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        $(document).ready(function () {
            $('#proyectos-content').removeClass('hidden');
            $('#requerimientos-content').removeClass('hidden');//AÑADI SOLO ESTO Y AHORA SI APARECE. POR QUE ?

            loadTabContent('@Url.Action("ListaProyectosPartial", "Proyecto")', '#proyectos-content');

            const openTab = '@(TempData["OpenTab"])';
            if (openTab === '#requerimientos-tab') {
                // Busca el botón de requerimientos y simula un clic
                $('button[data-tab-url*="ListaRequerimientosPartial"]').click();
            }
        });
    </script>
}