@model AROCONSTRUCCIONES.Dtos.PlanillaSemanalDto

<div class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
    <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
        <div>
            <h4 class="font-bold text-slate-800">@Model.ProyectoNombre</h4>
            <p class="text-xs text-slate-500">Periodo: @Model.FechaInicio.ToString("dd/MM") al @Model.FechaFin.ToString("dd/MM/yyyy")</p>
        </div>
        <div class="text-right">
            <p class="text-sm text-slate-500">Total Neto a Pagar</p>
            <p class="text-2xl font-bold text-green-600">S/ @Model.TotalNeto.ToString("N2")</p>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-100">
                <tr>
                    <th class="px-4 py-2 text-left font-bold text-slate-600">Trabajador</th>
                    <th class="px-4 py-2 text-left font-bold text-slate-600">Cargo</th>
                    <th class="px-4 py-2 text-center font-bold text-slate-600">Días</th>
                    <th class="px-4 py-2 text-right font-bold text-slate-600">Básico</th>
                    <th class="px-4 py-2 text-right font-bold text-slate-600">Extras</th>
                    <th class="px-4 py-2 text-right font-bold text-slate-600">BUC</th>
                    <th class="px-4 py-2 text-right font-bold text-slate-600">Bruto</th>
                    <th class="px-4 py-2 text-right font-bold text-red-500">Descuentos</th>
                    <th class="px-4 py-2 text-right font-bold text-green-700">NETO</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
                @for (int i = 0; i < Model.Detalles.Count; i++)
                {
                    var item = Model.Detalles[i];
                    <tr>
                        <td class="px-4 py-2">@item.TrabajadorNombre</td>
                        <td class="px-4 py-2 text-xs text-slate-500">@item.Cargo</td>
                        <td class="px-4 py-2 text-center">@item.DiasTrabajados</td>
                        <td class="px-4 py-2 text-right">@item.SueldoBasico.ToString("N2")</td>
                        <td class="px-4 py-2 text-right">@item.PagoExtras.ToString("N2")</td>
                        <td class="px-4 py-2 text-right">@item.BUC.ToString("N2")</td>
                        <td class="px-4 py-2 text-right font-medium">@item.TotalBruto.ToString("N2")</td>
                        <td class="px-4 py-2 text-right text-red-500">@item.TotalDescuentos.ToString("N2")</td>
                        <td class="px-4 py-2 text-right font-bold text-green-700 bg-green-50">@item.NetoAPagar.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end">
        <button id="btnAprobarPlanilla" class="px-6 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 font-medium flex items-center">
            <i class="fas fa-check-double mr-2"></i> Aprobar y Enviar a Tesorería
        </button>
    </div>
</div>

<script>
    $('#btnAprobarPlanilla').click(function() {

        // Verificar en consola del navegador qué valor tiene
        var pId = @Model.ProyectoId;
        console.log("Proyecto ID a enviar:", pId);

        if (!pId || pId <= 0) {
            Swal.fire('Error', 'El ID del proyecto no es válido (' + pId + '). Recargue la página.', 'error');
            return;
        }
        // --- CORRECCIÓN: Construir el objeto explícitamente ---
        // Recolectamos los datos básicos del modelo actual
        var planillaData = {
            // Aseguramos que el ID del proyecto se envíe
            ProyectoId: pId, // Usamos la variable capturada
            FechaInicio: '@Model.FechaInicio.ToString("yyyy-MM-dd")',
            FechaFin: '@Model.FechaFin.ToString("yyyy-MM-dd")',
            Codigo: '@Model.Codigo',
            TotalBruto: @Model.TotalBruto,
            TotalNeto: @Model.TotalNeto,
            // Reconstruimos los detalles leyendo el modelo original de C#
            // (Esto convierte la lista de C# a un array JSON seguro)
            Detalles: @Html.Raw(Json.Serialize(Model.Detalles))
        };

        console.log("Enviando Planilla:", planillaData); // Para depurar en consola (F12)

        Swal.fire({
            title: '¿Aprobar Planilla?',
            text: "Se generará una Solicitud de Pago por S/ " + planillaData.TotalNeto.toFixed(2),
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, aprobar',
            confirmButtonColor: '#10B981', // Verde
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '@Url.Action("AprobarPlanilla", "RRHH")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(planillaData),
                    success: function(res) {
                        if(res.success) {
                             Swal.fire({
                                 title: '¡Éxito!',
                                 text: 'Planilla enviada a Tesorería',
                                 icon: 'success',
                                 timer: 2000,
                                 showConfirmButton: false
                             }).then(() => {
                                 // Recargar pestaña
                                 if (typeof loadTabContent === 'function') {
                                     // Simulamos clic en el botón de la pestaña Planillas
                                     $('button[data-tab-url*="PlanillaIndex"]').click();
                                 } else { location.reload(); }
                             });
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    },
                    error: function(xhr) {
                        Swal.fire('Error de Servidor', 'No se pudo guardar la planilla. Revise la consola.', 'error');
                        console.error(xhr.responseText);
                    }
                });
            }
        });
    });
</script>