@using AROCONSTRUCCIONES.Dtos
@{
    ViewData["Title"] = "Logística y Almacén";

    // Obtenemos los datos del dashboard para las mini-cards del header
    var dashboard = ViewBag.DashboardData as LogisticaDashboardDto ?? new LogisticaDashboardDto();
}

<partial name="_ComprasAlmacenHeaderPartial" model="dashboard" />

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">
            <i class="fas fa-chart-pie mr-2 text-blue-500"></i> Inversión por Almacén (S/.)
        </h4>
        <div class="h-64">
            <canvas id="chartInversionAlmacen"></canvas>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">
            <i class="fas fa-chart-bar mr-2 text-green-500"></i> Top 5 Materiales más Consumidos
        </h4>
        <div class="h-64">
            <canvas id="chartTopConsumo"></canvas>
        </div>
    </div>
</div>

<div x-data="{ activeTab: 'inventario' }" class="w-full mt-6">

    <div class="flex space-x-2">
        <nav class="inline-flex h-10 items-center justify-center rounded-lg bg-gray-200 p-1 text-gray-600" aria-label="Tabs">

            @{
                const string activeStyle = "bg-white text-gray-900 shadow-sm";
                const string inactiveStyle = "text-gray-600 hover:bg-white/50";
                const string baseClasses = "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 disabled:opacity-50";
            }

            <button x-on:click="activeTab = 'inventario'; loadTabContent('@Url.Action("InventarioPartial", "Inventario")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'inventario', '@inactiveStyle': activeTab !== 'inventario' }"
                    class="@baseClasses">
                <i class="fas fa-boxes mr-2"></i> Inventario
            </button>

            <button x-on:click="activeTab = 'despachos'; loadTabContent('@Url.Action("ListaPendientesDespachoPartial", "Inventario")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'despachos', '@inactiveStyle': activeTab !== 'despachos' }"
                    class="@baseClasses">
                <i class="fas fa-truck-loading mr-2 text-amber-600"></i> Atención Pedidos
            </button>

            @if (User.IsInRole("Administrador") || User.IsInRole("Usuario"))
            {
                <button x-on:click="activeTab = 'aprobados'; loadTabContent('@Url.Action("ListaRequerimientosAprobadosPartial", "Inventario")', '#tab-content-container')"
                        :class="{ '@activeStyle': activeTab === 'aprobados', '@inactiveStyle': activeTab !== 'aprobados' }"
                        class="@baseClasses">
                    <i class="fas fa-check-double mr-2 text-green-500"></i> Por Comprar
                </button>
            }

            <button x-on:click="activeTab = 'movimientos'; loadTabContent('@Url.Action("TablaMovimientosPartial", "MovimientoInventario")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'movimientos', '@inactiveStyle': activeTab !== 'movimientos' }"
                    class="@baseClasses">
                <i class="fas fa-dolly mr-2"></i> Movimientos
            </button>

            <button x-on:click="activeTab = 'materiales'; loadTabContent('@Url.Action("ListaMateriales", "Material")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'materiales', '@inactiveStyle': activeTab !== 'materiales' }"
                    class="@baseClasses">
                <i class="fas fa-cube mr-2"></i> Catálogo
            </button>
            <!-- Pestaña 4: Órdenes de Compra -->
            <button x-on:click="activeTab = 'ordenes'; loadTabContent('@Url.Action("ListaOrdenes", "OrdenCompra")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'ordenes', '@inactiveStyle': activeTab !== 'ordenes' }"
                    class="@baseClasses">
                <i class="fas fa-file-invoice mr-2"></i> Órdenes de Compra
            </button>

            <button x-on:click="activeTab = 'almacenes'; loadTabContent('@Url.Action("ListaAlmacenes", "Almacen")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'almacenes', '@inactiveStyle': activeTab !== 'almacenes' }"
                    class="@baseClasses">
                <i class="fas fa-warehouse mr-2"></i> Almacenes
            </button>

            <button x-on:click="activeTab = 'reportes'; loadTabContent('@Url.Action("Index", "ReportesLogistica")', '#tab-content-container')"
                    :class="{ '@activeStyle': activeTab === 'reportes', '@inactiveStyle': activeTab !== 'reportes' }"
                    class="@baseClasses">
                <i class="fas fa-chart-pie mr-2 text-blue-600"></i> Reportes
            </button>


        </nav>
    </div>

    <div id="tab-content-container" class="mt-6 bg-white p-4 rounded-lg shadow-sm border border-slate-100 min-h-[400px]">
        <div class="flex items-center justify-center h-48 text-slate-400">
            <i class="fas fa-spinner fa-spin mr-2"></i> Cargando información...
        </div>
    </div>

    <div id="modal-placeholder"></div>

</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/logistica-tabs.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        // --- 1. FUNCIÓN GLOBAL PARA MODALES (Accesible desde cualquier parcial) ---
        function cargarModalMovimiento(tipo) {
            let url = (tipo === 'transferencia')
                ? '@Url.Action("GetTransferenciaModal", "MovimientoInventario")'
                : '@Url.Action("GetMovimientoModal", "MovimientoInventario")?tipo=' + tipo;

            $.get(url, function (data) {
                $('#modal-placeholder').html(data);
            });
        }
        // --- 2. GESTIÓN DE DESPACHO (ATENCIÓN DE REQUERIMIENTO) ---
        function cargarModalDespacho(requerimientoId) {
            const url = '@Url.Action("GetDespachoRequerimientoModal", "Inventario")/' + requerimientoId;
            $.get(url, function (data) {
                $('#modal-placeholder').html(data);
            }).fail(function() {
                Swal.fire('Error', 'No se pudo cargar el requerimiento', 'error');
            });
        }

        // Esta función procesa el formulario masivo del modal que creamos antes
        $(document).on('submit', '#formDespachoMasivo', function (e) {
            e.preventDefault();
            const $form = $(this);

            Swal.fire({
                title: '¿Confirmar Salida?',
                text: "Se actualizará el stock de los materiales seleccionados.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                confirmButtonText: 'Sí, despachar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: $form.attr('action'),
                        type: 'POST',
                        data: $form.serialize(),
                        success: function (res) {
                            if (res.success) {
                                Swal.fire('¡Éxito!', res.message, 'success').then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Error', res.message, 'error');
                            }
                        }
                    });
                }
            });
        });

        // --- 2. INICIALIZACIÓN DE GRÁFICOS (Chart.js) ---
        function inicializarGraficosDashboard() {
            $.get('@Url.Action("GetLogisticaChartData", "Dashboard")', function(response) {

                // Gráfico 1: Inversión por Almacén
                new Chart(document.getElementById('chartInversionAlmacen'), {
                    type: 'doughnut',
                    data: {
                        labels: response.inversionPorAlmacen.map(x => x.label),
                        datasets: [{
                            data: response.inversionPorAlmacen.map(x => x.value),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                // Gráfico 2: Top Consumo Materiales
                new Chart(document.getElementById('chartTopConsumo'), {
                    type: 'bar',
                    data: {
                        labels: response.consumoTopMateriales.map(x => x.label),
                        datasets: [{
                            label: 'Gasto Acumulado (S/.)',
                            data: response.consumoTopMateriales.map(x => x.value),
                            backgroundColor: '#3b82f6',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            });
        }

        // --- 3. CARGA INICIAL ---
        $(document).ready(function () {
             inicializarGraficosDashboard();

             // Cargar pestaña inicial basada en TempData o por defecto Inventario
             const initialUrl = '@Url.Action("InventarioPartial", "Inventario")';
             loadTabContent(initialUrl, '#tab-content-container');
         });
    </script>
}