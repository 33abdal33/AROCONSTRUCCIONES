@model IEnumerable<AROCONSTRUCCIONES.Dtos.InventarioDto>

@{
    var proyectos = ViewBag.Proyectos as SelectList;
}

@* 1. CSS REFORZADO PARA LIMPIEZA TOTAL *@
<style>
    /* Eliminamos cualquier borde que DataTables intente forzar */
    table.dataTable,
    table.dataTable.no-footer,
    .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody {
        border-bottom: none !important;
    }

    #mainInventoryTable,
    #mainInventoryTable.no-footer {
        border-bottom: none !important;
        border-top: none !important;
    }

        #mainInventoryTable thead th {
            border-bottom: none !important;
            letter-spacing: normal !important;
        }

        /* Quitamos el borde que DataTables pone a la última fila */
        #mainInventoryTable tbody tr:last-child td {
            border-bottom: none !important;
        }
</style>

@* Silenciamos errores técnicos *@
<script>$.fn.dataTable.ext.errMode = 'none';</script>

<div class="pt-2">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-emerald-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-100 transition-transform hover:scale-105">
                <i class="fas fa-boxes text-white text-2xl"></i>
            </div>
            <div>
                <h3 class="text-2xl font-bold text-slate-800 tracking-tight">Control de Inventario</h3>
                <p class="text-sm font-medium text-slate-500">Suministros y existencias en tiempo real</p>
            </div>
        </div>

        <div class="flex items-center gap-3 w-full lg:w-auto">
            <button onclick="cargarModalMovimiento('transferencia')"
                    class="flex-1 lg:flex-none bg-white border border-slate-200 hover:border-amber-400 text-slate-600 hover:text-amber-600 px-6 py-2.5 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 shadow-sm uppercase">
                <i class="fas fa-exchange-alt"></i> Transferencia
            </button>
            <button onclick="cargarModalMovimiento('INGRESO')"
                    class="flex-1 lg:flex-none bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2 shadow-sm uppercase">
                <i class="fas fa-plus-circle"></i> Registrar Ingreso
            </button>
        </div>
    </div>

    <div class="bg-slate-100/50 p-2 rounded-2xl mb-6 border border-slate-200/60 shadow-sm">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
            <div class="md:col-span-5 relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400">
                    <i class="fas fa-search text-sm"></i>
                </span>
                <input type="text" id="customSearchInput"
                       class="w-full pl-11 pr-4 py-2.5 rounded-xl border-transparent bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-medium transition-all shadow-sm"
                       placeholder="Buscar por material, marca o código...">
            </div>

            <div class="md:col-span-4">
                <select id="filterProyecto" onchange="filtrarPorProyecto(this.value)"
                        class="w-full px-4 py-2.5 rounded-xl border-transparent bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-600 shadow-sm cursor-pointer"
                        asp-items="proyectos">
                    <option value="">🏢 Todos los Almacenes</option>
                </select>
            </div>

            <div class="md:col-span-3">
                <select id="filterStatus" class="w-full px-4 py-2.5 rounded-xl border-transparent bg-white focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm font-bold text-slate-600 shadow-sm cursor-pointer">
                    <option value="">📊 Todos los Estados</option>
                    <option value="Normal">Normal</option>
                    <option value="Bajo">Stock Bajo</option>
                    <option value="Crítico">Crítico</option>
                </select>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-3xl border border-slate-200 shadow-xl shadow-slate-200/30 overflow-hidden">
        <table class="min-w-full divide-y divide-slate-100" id="mainInventoryTable">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">Código</th>
                    <th class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">Material / Categoría</th>
                    <th class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">Existencias</th>
                    <th class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">Costo Unit.</th>
                    <th class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">Valorización</th>
                    <th class="px-6 py-4 text-center text-[11px] font-bold text-slate-400 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">Almacén</th>
                    <th class="px-6 py-4 w-10"></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
                @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        var color = item.NivelAlerta == 0 ? "emerald" : (item.NivelAlerta == 1 ? "amber" : "rose");

                        <tr class="hover:bg-slate-50 transition-all">
                            <td class="px-6 py-4 text-sm font-mono font-bold text-slate-400">@item.MaterialCodigo</td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-slate-800">@item.MaterialNombre</div>
                                <div class="text-[11px] font-medium text-slate-400 uppercase">@item.MaterialCategoria</div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="text-base font-bold text-slate-900">@item.StockActual.ToString("N2")</span>
                                <span class="text-[10px] font-bold text-slate-400 ml-1">@item.MaterialUnidadMedida</span>
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-semibold text-slate-500">
                                S/ @item.CostoPromedio.ToString("N2")
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="text-sm font-bold text-indigo-600">S/ @item.ValorTotal.ToString("N2")</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-@color-100 text-@color-700 border border-@color-200">
                                    <span class="w-1.5 h-1.5 rounded-full bg-@color-500 mr-2"></span>
                                    @(item.NivelAlerta == 0 ? "Normal" : (item.NivelAlerta == 1 ? "Bajo" : "Crítico"))
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-xs font-bold text-slate-600 italic">@item.AlmacenNombre</div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <a asp-action="Details" asp-controller="Inventario" asp-route-materialId="@item.MaterialId" asp-route-almacenId="@item.AlmacenId"
                                   class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all"
                                   title="Ver Kárdex">
                                    <i class="fas fa-history"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="mt-6 flex flex-col md:flex-row justify-between items-center px-4 gap-4">
        <div id="tableInfoContainer" class="text-xs font-bold text-slate-400 uppercase tracking-wider">
        </div>
        <div id="paginationContainer" class="flex gap-1.5">
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        const table = $('#mainInventoryTable').DataTable({
            "dom": "t",
            "pageLength": 10,
            "destroy": true,
            "language": { "zeroRecords": "No hay materiales registrados" },
            "order": [[1, 'asc']],
            "drawCallback": function(settings) {
                const api = this.api();
                const info = api.page.info();

                $('#tableInfoContainer').html(
                    `PÁGINA <span class="text-slate-800">${info.page + 1}</span> DE <span class="text-slate-800">${info.pages}</span> — TOTAL: <span class="text-slate-800">${info.recordsTotal}</span>`
                );

                renderCustomPagination(api);
            }
        });

        $('#customSearchInput').on('keyup', function() {
            table.search(this.value).draw();
        });

        $('#filterStatus').on('change', function() {
            table.column(5).search(this.value).draw();
        });

        function renderCustomPagination(api) {
            const info = api.page.info();
            let html = '';
            if(info.pages <= 1) { $('#paginationContainer').html(''); return; }

            html += `<button onclick="changePage('prev')" class="${info.page === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-white border-slate-200'} p-2 rounded-lg border bg-slate-50 text-slate-600 transition-all"><i class="fas fa-chevron-left text-xs"></i></button>`;

            for(let i = 0; i < info.pages; i++) {
                if (i === info.page) {
                    html += `<button class="px-3.5 py-1.5 rounded-lg bg-indigo-600 text-white font-bold text-xs shadow-md shadow-indigo-100">${i + 1}</button>`;
                } else {
                    html += `<button onclick="apiPage(${i})" class="px-3.5 py-1.5 rounded-lg bg-white border border-slate-200 text-slate-600 font-bold text-xs hover:bg-slate-50 transition-all">${i + 1}</button>`;
                }
            }

            html += `<button onclick="changePage('next')" class="${info.page === info.pages - 1 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-white border-slate-200'} p-2 rounded-lg border bg-slate-50 text-slate-600 transition-all"><i class="fas fa-chevron-right text-xs"></i></button>`;

            $('#paginationContainer').html(html);
        }

        window.apiPage = function(idx) { table.page(idx).draw('page'); };
        window.changePage = function(dir) {
            if(dir === 'prev') table.page('previous').draw('page');
            else table.page('next').draw('page');
        };
    });

    function filtrarPorProyecto(id) {
        const url = '@Url.Action("InventarioPartial", "Inventario")';
        loadTabContent(`${url}?proyectoId=${id}`, '#tab-content-container');
    }
</script>