@model IEnumerable<AROCONSTRUCCIONES.Dtos.MovimientoInventarioDto>
@using AROCONSTRUCCIONES.Dtos

@{
    // 1. Recuperamos el DTO del Saldo que pasamos desde el controlador
    var saldo = ViewData["Saldo"] as InventarioDto;
    ViewData["Title"] = $"Kárdex - {saldo?.MaterialNombre}";
}

<div class="container-fluid pt-4">

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0">
                    <i class="fas fa-history me-2 text-primary"></i>
                    Historial de Movimientos
                </h3>
            </div>
            <a asp-action="Index" asp-controller="Inventario" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-2"></i>
                Volver al Inventario
            </a>
        </div>
        <div class="card-body">
            @if (saldo != null)
            {
                <div class="row">
                    <div class="col-md-4">
                        <h5 class="text-muted">Material</h5>
                        <h3>@saldo.MaterialNombre</h3>
                        <small class="text-muted">Código: @saldo.MaterialCodigo</small>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-muted">Almacén</h5>
                        <h3>@saldo.AlmacenUbicacion</h3>
                    </div>
                    <div class="col-md-2 text-end">
                        <h5 class="text-muted">Stock Actual</h5>
                        <h3 class="text-success fw-bold">@saldo.StockActual.ToString("N0")</h3>
                    </div>
                    <div class="col-md-2 text-end">
                        <h5 class="text-muted">Valorizado (Costo)</h5>
                        <h3 class="fw-bold">S/ @saldo.ValorTotal.ToString("N2")</h3>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="tablaKardex">
                    <thead class="table-light">
                        <tr>
                            <th class="text-nowrap">Fecha y Hora</th>
                            <th>Tipo</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Costo Unit.</th>
                            <th class="text-end fw-bold">Stock Final</th>
                            <th>Documento</th>
                            <th>Motivo</th>
                            <th>Responsable</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var mov in Model)
                            {
                                bool esEntrada = mov.TipoMovimiento == "INGRESO";
                                var tipoClaseBg = esEntrada ? "bg-success" : "bg-danger";
                                var tipoClaseText = esEntrada ? "text-success" : "text-danger";
                                var iconoTipo = esEntrada ? "fas fa-arrow-alt-circle-up" : "fas fa-arrow-alt-circle-down";
                                var signoCantidad = esEntrada ? "+" : "-";

                                <tr>
                                    <td class="text-nowrap">@mov.FechaMovimiento.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <span class="badge rounded-pill @tipoClaseBg bg-opacity-10 @tipoClaseText fw-bold">
                                            <i class="@iconoTipo me-1"></i>
                                            @(esEntrada ? "ENTRADA" : "SALIDA")
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span class="fw-bold @tipoClaseText">
                                            @signoCantidad@mov.Cantidad.ToString("N0")
                                        </span>
                                        <small class="text-muted">@mov.UnidadMedida</small>
                                    </td>
                                    <td class="text-end">S/ @mov.CostoUnitarioMovimiento.ToString("N2")</td>
                                    <td class="text-end fw-bold">
                                        @mov.StockFinal.ToString("N0")
                                        <small class="text-muted">@mov.UnidadMedida</small>
                                    </td>
                                    <td>@mov.NroFacturaGuia</td>
                                    <td>@mov.Motivo</td>
                                    <td>@mov.ResponsableNombre</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center p-4 text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No hay historial de movimientos para este ítem.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Inicializamos DataTables para esta tabla específica
        $(document).ready(function() {
            $('#tablaKardex').DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json" },
                pageLength: 10,
                order: [[0, "desc"]] // Ordenar por fecha descendente
            });
        });
    </script>
}