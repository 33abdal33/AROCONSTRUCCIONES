@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="pt-4">
    <h3 class="text-xl font-semibold text-slate-700 mb-4">
        <i class="fas fa-chart-pie mr-2 text-blue-600"></i>
        Módulo de Reportes de Logística
    </h3>

    <div class="bg-white rounded-lg shadow-md mb-6 border-t-4 border-blue-500">
        <div class="border-b border-gray-200 p-4">
            <strong class="text-slate-700"><i class="fas fa-history mr-2"></i>Reporte: Kárdex por Material</strong>
        </div>
        <div class="p-4">
            <form id="formReporteKardex">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Material</label>
                        <select id="kardexMaterialId" name="materialId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" asp-items="@ViewBag.Materiales" required>
                            <option value="">Seleccione un material...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Almacén</label>
                        <select id="kardexAlmacenId" name="almacenId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" asp-items="@ViewBag.Almacenes" required>
                            <option value="">Seleccione un almacén...</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="w-full flex justify-center items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-blue-700 transition">
                            <i class="fas fa-search mr-2"></i> Generar Kárdex
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-6 border-t-4 border-green-500">
        <div class="border-b border-gray-200 p-4">
            <strong class="text-slate-700"><i class="fas fa-project-diagram mr-2 text-green-600"></i>Reporte: Consumo por Proyecto (Obra)</strong>
        </div>
        <div class="p-4">
            <form id="formReporteConsumoProyecto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Seleccionar Proyecto</label>
                        <select id="reporteProyectoId" name="proyectoId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" asp-items="@ViewBag.Proyectos" required>
                            <option value="">Seleccione un proyecto...</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="w-full flex justify-center items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-green-700 transition">
                            <i class="fas fa-chart-bar mr-2"></i> Analizar Consumo
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-6 border-t-4 border-amber-500">
        <div class="border-b border-gray-200 p-4">
            <strong class="text-slate-700"><i class="fas fa-coins mr-2 text-amber-600"></i>Reporte: Valorización de Inventario</strong>
        </div>
        <div class="p-4">
            <form id="formReporteStockValorizado">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Almacén (Opcional)</label>
                        <select id="almacenValorizadoId" name="almacenId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" asp-items="@ViewBag.Almacenes">
                            <option value="">-- Todos los Almacenes --</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="w-full flex justify-center items-center px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-amber-700 transition">
                            <i class="fas fa-dollar-sign mr-2"></i> Ver Valorización
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="reporteResultadoContenedor"></div>
</div>

<script>
    $(document).ready(function() {
        // Función genérica para cargar reportes
        function cargarReporte(formId, actionName, params) {
            const $contenedor = $('#reporteResultadoContenedor');
            const $boton = $(formId).find('button[type="submit"]');
            const originalHtml = $boton.html();

            $boton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i> Generando...');
            $contenedor.html('<div class="flex justify-center items-center p-10 text-blue-500"><i class="fas fa-spinner fa-spin fa-3x"></i></div>');

            const url = '/ReportesLogistica/' + actionName;

            $.get(url, params, function(data) {
                $contenedor.html(data);
                if (typeof initializeDataTables === "function") { initializeDataTables(); }
            })
            .fail(function(xhr) {
                $contenedor.html('');
                Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo generar el reporte: ' + xhr.responseText });
            })
            .always(function() {
                $boton.prop('disabled', false).html(originalHtml);
            });
        }

        $('#formReporteKardex').on('submit', function(e) {
            e.preventDefault();
            cargarReporte('#formReporteKardex', 'GenerarReporteKardex', { materialId: $('#kardexMaterialId').val(), almacenId: $('#kardexAlmacenId').val() });
        });

        $('#formReporteConsumoProyecto').on('submit', function(e) {
            e.preventDefault();
            cargarReporte('#formReporteConsumoProyecto', 'GenerarReporteConsumoProyecto', { proyectoId: $('#reporteProyectoId').val() });
        });

        $('#formReporteStockValorizado').on('submit', function(e) {
            e.preventDefault();
            cargarReporte('#formReporteStockValorizado', 'GenerarReporteStockValorizado', { almacenId: $('#almacenValorizadoId').val() });
        });
    });
</script>